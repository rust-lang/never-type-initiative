<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>No inference changes - Never Type initiative</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../index.html">üëã Welcome</a></li><li class="chapter-item "><a href="../updates.html">‚úèÔ∏è Updates</a></li><li class="chapter-item "><a href="../CHARTER.html">üìú Charter</a></li><li class="chapter-item expanded "><a href="../evaluation.html">üî¨ Evaluation</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../evaluation/issues.html">PRs/Issues</a></li><li class="chapter-item expanded "><a href="../evaluation/no-inference-changes.html" class="active">No inference changes</a></li></ol></li><li class="chapter-item "><a href="../explainer.html">üìö Explainer</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../explainer/conditional-fallback-v1.html">Conditional Fallback v1</a></li></ol></li><li class="chapter-item "><a href="../RFC.html">‚ú® RFC</a></li><li class="chapter-item "><a href="../FAQ.html">üòï FAQ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Never Type initiative</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rust-lang/never-type-initiative" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/rust-lang/never-type-initiative/edit/master/./evaluation/no-inference-changes.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>This discusses the impact of just stabilizing <code>!</code> syntax and changing
<code>std::convert::Infallible</code> to be an alias for <code>!</code>. (That is, no inference
algorithm changes).</p>
<h1 id="regression-inference-failures"><a class="header" href="#regression-inference-failures">Regression: inference failures</a></h1>
<p>This leads to the regression identified in
<a href="https://github.com/rust-lang/rust/issues/66757">rust-lang/rust#66757</a>.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct E;

impl From&lt;!&gt; for E {
    fn from(_: !) -&gt; E {
        E
    }
}

#[allow(unreachable_code)]
fn foo(never: !) {
    &lt;E as From&lt;!&gt;&gt;::from(never);  // Ok
    &lt;E as From&lt;_&gt;&gt;::from(never);  // Inference fails here
}
<span class="boring">}
</span></code></pre></pre>
<p>Without changes to type inference fallback, code such as the above with
<em>explicit</em> <code>!</code> type now fails to compile. This happens because with <code>!</code>, unlike
with <code>std::convert::Infallible</code>, <code>!</code> can coerce to any variable. That means that
the coercion from <code>!</code> to <code>_</code> <em>succeeds</em>, leading to the inference failure here,
as there's no constraint placed on the argument.</p>
<p>The coercion to inference variables is <em>in general</em> desirable, because of code
like this:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>if foo {
    loop {}
}
<span class="boring">}
</span></code></pre></pre>
<p><code>if</code> expressions without else currently desugar such that the &quot;block&quot; is typed
at an inference variable (later eq'd with <code>()</code>), so the coercion to an inference
variable is necessary to make this work with the current compiler
implementation.  Further, changing the compiler to avoid this seems relatively
hard (FIXME: just how hard?). This regression is prominent enough that it makes
fully avoiding inference changes not possible.</p>
<h1 id="con-misleadingconfusing-fallback"><a class="header" href="#con-misleadingconfusing-fallback">Con: misleading/confusing fallback</a></h1>
<p>This leads to the painpoint (amongst others) identified in
<a href="https://github.com/rust-lang/rust/issues/66738">rust-lang/rust#66738</a>. This may
also be a regression in some cases if users start more explicitly writing <code>!</code> in
some places, though is not directly one at just stabilization time.</p>
<pre><pre class="playground"><code class="language-rust">fn magic&lt;R, F: FnOnce() -&gt; R&gt;(f: F) -&gt; F { f }

fn main() {
    let f2 = magic(|| loop {}) as fn() -&gt; !;
}
</code></pre></pre>
<p>The (presumed) expected behavior is that <code>loop {}</code>, having type <code>!</code>, means that
the closure above will have a return type of <code>!</code>. However, that's not what
actually happens: the closure's return type is set to an inference variable,
<code>?T</code>. Since expressions in the return position are coerced to the return type,
we end up with no requirement on the return type's inference variable. (The cast
does not participate in inference, generally). This means that the inference
variable is unconstrained and so falls back to <code>()</code>.</p>
<p>Note that this behavior is currently relied upon by some libraries. For example,
code like this is relatively common, which requires that closures return <code>()</code> or
<code>u32</code>. This means that if the fallback doesn't go to <code>()</code>, we will end up with
an error.</p>
<pre><pre class="playground"><code class="language-rust">trait Bar { }
impl Bar for () {  }
impl Bar for u32 {  }

fn foo&lt;R: Bar&gt;(_: impl Fn() -&gt; R) {}

fn main() {
    foo(|| panic!());
}
</code></pre></pre>
<p>Take a snippet from <a href="https://github.com/seanmonstar/warp/blob/v0.1.11/src/test.rs#L491-L496">warp 0.1.11</a>:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>wr_rx.map_err(|()| {
    unreachable!(&quot;mpsc::Receiver doesn't error&quot;);
})
.forward(tx.sink_map_err(|_| ()))
.map(|_| ());
<span class="boring">}
</span></code></pre></pre>
<p>This code fails if the first closure is typed as <code>impl Fn(()) -&gt; !</code>, because
<code>forward</code> requires that <code>!: From&lt;()&gt;</code> (i.e., that the error types are
compatible). That impl is not currently available, so this code doesn't work
out.</p>
<p>This kind of interaction is relatively common, which makes changes to closure
return types that &quot;make sense&quot; at an intuitive level actually commonly result in
errors.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../evaluation/issues.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../explainer.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../evaluation/issues.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../explainer.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
